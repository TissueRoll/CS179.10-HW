<!doctype html>

<html>
<meta charset="utf-8">
<title>GJK â€” 160696</title>
<style>
body {
	position: absolute;
	width: 100%;
	height: 100%;
	border: 0;
	padding: 0;
	margin: 0;
}
#c {
	position: absolute;
	width: 100%;
	height: 100%;
}
#s {
	position: absolute;
	overflow: wrap;

	left: 10px;
	width: 150px;
	top: 10px;
}
#result {
	position: absolute;
	right: 10px;
	width: 150px;
	top: 10px;
}
</style>

<body>
<canvas id="c"></canvas>
<div id="s">Left click to place polygon A, right click to place polygon B. Press enter to commit polygon being edited.</div>
<div id="result"></div>
<script>
var s = document.getElementById("s");
var c = document.getElementById("c");
var r = document.getElementById("result");
c.width = c.clientWidth;
c.height = c.clientHeight;

var g = c.getContext('2d');


var current_point = -1;
var editing = 0;
var polygonA = [];
var polygonB = [];

var distance = null;

function draw() {
	g.clearRect(0, 0, c.width, c.height);
	g.beginPath();
	if ( polygonA.length > 0 ) {
		g.moveTo(polygonA[0][0], polygonA[0][1]);
	}

	for ( var i = 1; i < polygonA.length; ++i ) {
		g.lineTo(polygonA[i][0], polygonA[i][1]);
	}
	g.closePath();
	g.strokeStyle = '#F00';
	g.stroke();

	g.beginPath();
	if ( polygonB.length > 0 ) {
		g.moveTo(polygonB[0][0], polygonB[0][1]);
	}

	for ( var i = 1; i < polygonB.length; ++i ) {
		g.lineTo(polygonB[i][0], polygonB[i][1]);
	}
	g.closePath();
	g.strokeStyle = '#00F';
	g.stroke();

	//draw the closest points and the line between them
	if ( distance ) {
		var pa = distance[0];
		var pb = distance[1];

		g.beginPath();
		g.moveTo(pa[0], pa[1]);
		g.lineTo(pb[0], pb[1]);
		g.strokeStyle = '#2A4';
		g.stroke();

		g.beginPath();
		g.ellipse(pa[0], pa[1], 5, 5, 0, 0, Math.PI * 2);
		g.strokeStyle = '#FA0';
		g.fillStyle = '#FA0';
		g.stroke();
		g.fill();

		g.beginPath();
		g.ellipse(pb[0], pb[1], 5, 5, 0, 0, Math.PI * 2);
		g.strokeStyle = '#0AF';
		g.fillStyle = '#0AF';
		g.stroke();
		g.fill();

		g.fillStyle = null;
	}
}

c.addEventListener('mousedown', function(ev) {
	if ( ev.button == 0 ) {
		if ( editing != 1 ) {
			polygonA = [[ev.x, ev.y]];
			editing = 1;
			current_point = 0;
		}
		polygonA.push([ev.x, ev.y]);
		++current_point;
	} else {
		if ( editing != 2 ) {
			polygonB = [[ev.x, ev.y]];
			editing = 2;
			current_point = 0;
		}
		polygonB.push([ev.x, ev.y]);
		++current_point;
		ev.preventDefault();
	}

	draw();
	return false;
});
c.oncontextmenu = function() { return false; }

c.addEventListener('mousemove', function(ev) {
	if ( editing == 1 ) {
		polygonA[current_point][0] = ev.x;
		polygonA[current_point][1] = ev.y;
		draw();
	} else if ( editing == 2 ) {
		polygonB[current_point][0] = ev.x;
		polygonB[current_point][1] = ev.y;
		draw();
	}
});

document.addEventListener('keypress', function(ev) {
	if ( ev.keyCode == 13 ) {
		editing = 0;

		distance = gjk(polygonA, polygonB);
		if ( distance ) {
			var dist = Math.hypot(distance[0][0] - distance[1][0], distance[0][1] - distance[1][1]);
			r.innerText = "Separated. Distance: " + dist;
		} else {
			r.innerText = "Intersecting";
		}
	}
	draw();
});

window.addEventListener('resize', function(ev) {
	c.width = c.clientWidth;
	c.height = c.clientHeight;
	draw();
});

</script>

<script>
function gjk(polygonA, polygonB) {
	// IMPLEMENT ME
	// return null if the polygons are intersecting, else return the array:
	// [[ax, ay], [bx,by]]
	// Where <ax, ay> is the point on polygonA closest to polygonB
	// and <bx, by> is the point on polygonB closest to polygonA

	var vneg = function(p) {return [-p[0], -p[1]];};
	var vsub = function(p0, p1) {return [p1[0]-p0[0], p1[1]-p0[1]];};
	var perp = function(p) {return [-p[1], p[0]];};
	var dot = function(u, v) {return u[0]*v[0]+u[1]*v[1];};
	var cross = function(u,v) {return u[0]*v[1]-u[1]*v[0];};
	var norm = function(v) {return Math.hypot(v[0],v[1]);};

	var gofar = function(poly, d) {
		var best = Number.NEGATIVE_INFINITY;
		var pt = null;
		for (var x of poly) {
			if (best < dot(x,d)) {
				best = dot(x,d);
				pt = x;
			}
		}
		return pt;
	};
	var support = function(polyA, polyB, d) {return vsub(gofar(polyA, d), gofar(polyB, vneg(d)));};
	var contains_origin = function(simplex) {
		
	};
	var is_intersecting = function(polyA, polyB) {
		var d = [1,0];

		var triangle = [support(polygonA, polygonB, d), support(polygonA, polygonB, vneg(d), [0,0]];

		while (true) {
			d = perp(vsub(triangle[1],triangle[0]));
			d = (dot(d,vneg(triangle[0])) >= 0 ? d : vneg(d));
			triangle[2] = support(polygonA, polygonB, d);
			if (dot(triangle[2],d) <= 0) {
				return false;
			} else {
				if (contains_origin(triangle)) {
					return true;
				} else { // iterate
					// check triangle[2]-triangle[1] and triangle[2]-triangle[0]
					// if check which of it is closer between the two lines
					var d21 = perp(vsub(triangle[2], triangle[1]));
					var d20 = perp(vsub(triangle[2], triangle[0]));
				}
			}
		}
	};


	return [ [100, 100], [240, 440] ];
}
</script>
</body>
</html>